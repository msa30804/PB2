{% extends 'posapp/base.html' %}

{% block title %}POS System{% endblock %}

{% block extra_css %}
<style>
    /* Cart styles */
    .cart-container {
        max-height: 400px;
        overflow-y: auto;
    }
    .cart-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
    }
    .cart-item:hover {
        background-color: #f8f9fa;
    }
    .product-card {
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 100%;
        border: none;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    }
    .product-card .card-img-top {
        height: 130px;
        object-fit: cover;
    }
    .product-card .card-body {
        padding: 1rem;
    }
    .product-card .card-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .product-card .card-text {
        font-weight: 700;
        color: #2c7be5;
    }
    .cart-totals {
        border-top: 2px solid #eaeaea;
        padding-top: 15px;
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    /* Custom styles for the POS interface */
    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    
    /* Remove receipt-related styles as they are no longer needed */
    
    /* Media query for print */
    @media print {
        body * {
            visibility: hidden;
        }
        .print-only, .print-only * {
            visibility: visible;
        }
        .print-only {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
    
    /* Category selector */
    .category-selector {
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
    }
    .category-btn {
        margin-right: 8px;
        border-radius: 20px;
        padding: 8px 15px;
        border: none;
        background-color: #f0f0f0;
        transition: all 0.2s;
    }
    .category-btn:hover, .category-btn.active {
        background-color: #2c7be5;
        color: white;
    }
    
    /* Search bar */
    .search-container {
        position: relative;
        margin-bottom: 20px;
    }
    .search-container input {
        border-radius: 25px;
        padding: 10px 15px 10px 40px;
        border: 1px solid #ddd;
        width: 100%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }
    
    /* Customer search */
    .customer-search-results {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .customer-item {
        padding: 8px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    .customer-item:hover {
        background-color: #f5f5f5;
    }
    
    /* Toast notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    
    /* Payment method styles */
    .payment-method {
        cursor: pointer;
        transition: all 0.3s;
        border-width: 2px !important;
    }
    .payment-method:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .payment-method.selected {
        border-color: var(--bs-primary) !important;
        background-color: rgba(44, 123, 229, 0.1);
    }
    
    /* Cart action buttons */
    .cart-actions {
        margin-top: 15px;
    }
    .cart-actions button {
        font-weight: 600;
    }
    
    /* Total line styling */
    .total-line {
        border-color: rgba(0,0,0,0.1) !important;
    }
    
    /* Empty cart message */
    .empty-cart-message {
        display: flex;
        height: 200px;
        justify-content: center;
        align-items: center;
        color: #adb5bd;
    }
    
    .disabled-product {
        opacity: 0.5;
        pointer-events: none;
        position: relative;
    }
    .disabled-product::after {
        content: "Out of Stock";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        background-color: rgba(220, 53, 69, 0.8);
        color: white;
        padding: 5px 10px;
        font-weight: bold;
        border-radius: 5px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block head_extras %}
<style type="text/css" media="print">
    @page {
        size: 80mm auto;  /* Receipt printer width */
        margin: 0;
        padding: 0;
    }
    body * {
        visibility: hidden;
    }
    .print-only, .print-only * {
        visibility: visible;
    }
    .print-only {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 0;
        margin: 0;
    }
    /* Prevent duplicate printing */
    #successModal, .modal-backdrop, .modal, .navbar, header, footer {
        display: none !important;
    }
    /* Hide everything else */
    #receipt-container {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
    }
    /* Control sheet count by limiting height */
    .receipt-preview {
        page-break-after: always;
        page-break-inside: avoid;
        max-height: 100%;
        overflow: visible;
    }
</style>
{% endblock %}

{% block content %}
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Point of Sale</h2>
        <div class="d-flex">
            <a href="{% url 'order_list' %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-list me-1"></i> Orders
            </a>
            <a href="{% url 'product_list' %}" class="btn btn-outline-success">
                <i class="fas fa-boxes me-1"></i> Products
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- Products Section -->
        <div class="col-md-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
            <!-- Categories -->
            <div class="mb-3 d-flex flex-wrap gap-2">
                        <button class="category-btn active" data-category="all">All Products</button>
                {% for category in categories %}
                        <button class="category-btn" data-category="{{ category.id }}">{{ category.name }}</button>
                {% endfor %}
            </div>
            
            <!-- Search Bar -->
                    <div class="search-container mb-4">
                        <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="product-search" placeholder="Search products...">
            </div>
            
            <!-- Product Grid -->
            <div class="products-container">
                        <div class="product-grid" id="products-grid">
                    {% for product in products %}
                            <div class="product-item" data-category="{{ product.category.id }}">
                                <div class="card h-100 product-card {% if not product.is_available or product.stock_quantity <= 0 and not product.running_item %}disabled-product{% endif %}" 
                                    data-id="{{ product.id }}" 
                                    data-name="{{ product.name }}" 
                                    data-price="{{ product.price }}"
                                    data-available="{% if product.is_available and product.stock_quantity > 0 or product.is_available and product.running_item %}true{% else %}false{% endif %}"
                                    data-running="{% if product.running_item %}true{% else %}false{% endif %}"
                                    data-category="{{ product.category.name }}">
                                    <div class="position-relative">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}" onerror="this.onerror=null; this.src='https://i.imgur.com/pTXpXpF.jpg';">
                            {% else %}
                                        <img src="https://i.imgur.com/pTXpXpF.jpg" class="card-img-top" alt="{{ product.name }}">
                                        {% endif %}
                                        <span class="position-absolute top-0 end-0 badge {% if product.running_item %}bg-info{% elif product.stock_quantity > 10 %}bg-success{% elif product.stock_quantity > 0 %}bg-warning{% else %}bg-danger{% endif %} m-2">
                                            {% if product.running_item %}
                                                âˆž
                                            {% else %}
                                                {{ product.stock_quantity }}
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title text-truncate">{{ product.name }}</h5>
                                        <div class="d-flex justify-content-between align-items-center mt-auto">
                                            <span class="card-text">Rs.{{ product.price }}</span>
                                            <button class="btn btn-sm btn-primary rounded-circle">
                                                <i class="fas fa-plus"></i>
                                            </button>
                            </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-4">
                        <p>No products available</p>
                    </div>
                    {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Cart</h5>
                </div>
                <div class="card-body">
                    <div class="cart-container mb-3">
                        <div id="cart-items">
                    <div class="empty-cart-message">
                        <div class="text-center">
                                    <i class="fas fa-shopping-cart fa-3x mb-3 text-muted"></i>
                                    <p class="text-muted">Your cart is empty</p>
                                </div>
                        </div>
                    </div>
                </div>
                
                    <div class="cart-totals">
                        <div class="p-3">
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted">Subtotal:</span>
                                <span id="cart-subtotal" class="fw-bold">Rs.0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Tax (<span id="tax-rate-display">15</span>%):</span>
                                <span id="cart-tax" class="fw-bold">Rs.0.00</span>
                    </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted">Discount:</span>
                                <span id="cart-discount" class="fw-bold">Rs.0.00</span>
                    </div>
                            <div class="d-flex justify-content-between total-line py-2 border-top border-bottom mb-3">
                                <span class="fs-5 fw-bold">Total:</span>
                                <span id="cart-total" class="fs-5 fw-bold text-primary">Rs.0.00</span>
                    </div>
                    
                    <div class="cart-actions">
                                <button class="btn btn-lg btn-danger w-100 mb-2" id="btn-clear">
                                    <i class="fas fa-trash me-2"></i> Clear Cart
                        </button>
                                <button class="btn btn-lg btn-primary w-100" id="btn-payment" disabled>
                                    <i class="fas fa-money-bill-wave me-2"></i> Process Order
                        </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header bg-primary text-white py-3">
                <h5 class="modal-title" id="paymentModalLabel"><i class="fas fa-shopping-bag me-2"></i>Process Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <!-- Left Column: Customer Information -->
                    <div class="col-md-7">
                        <!-- Customer Information Card -->
                        <div class="card mb-4 shadow-sm border-0 rounded-4 bg-light">
                            <div class="card-header bg-light py-3 rounded-top-4 border-0">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-user-circle me-2 text-primary"></i>Customer Information</h6>
                            </div>
                            <div class="card-body px-4">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Customer Name (Optional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text rounded-start-3 bg-white"><i class="fas fa-user"></i></span>
                                        <input type="text" class="form-control rounded-end-3" id="customerName" placeholder="Enter customer name">
                                    </div>
                                </div>
                                <div class="mb-0">
                                    <label for="customerPhone" class="form-label">Customer Phone (Optional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text rounded-start-3 bg-white"><i class="fas fa-phone"></i></span>
                                        <input type="text" class="form-control rounded-end-3" id="customerPhone" placeholder="Enter customer phone">
                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Order Notes Card -->
                        <div class="card mb-4 shadow-sm border-0 rounded-4 bg-light">
                            <div class="card-header bg-light py-3 rounded-top-4 border-0">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-sticky-note me-2 text-primary"></i>Order Notes</h6>
                            </div>
                            <div class="card-body px-4">
                                <textarea class="form-control rounded-3" id="orderNotes" rows="2" placeholder="Add any special instructions or notes"></textarea>
                            </div>
                        </div>
                
                        <!-- Payment Method Selection -->
                        <div class="card mb-4 shadow-sm border-0 rounded-4 bg-light">
                            <div class="card-header bg-light py-3 rounded-top-4 border-0">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-credit-card me-2 text-primary"></i>Payment Method</h6>
                            </div>
                            <div class="card-body px-4">
                                <div class="row g-3">
                                    <div class="col-4">
                                        <div class="payment-method selected rounded-4 border p-3 text-center shadow-sm" data-method="Cash">
                                            <i class="fas fa-money-bill-wave fa-2x mb-2 text-success"></i>
                                            <div class="fw-bold">Cash</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="payment-method rounded-4 border p-3 text-center shadow-sm" data-method="Card">
                                            <i class="fas fa-credit-card fa-2x mb-2 text-primary"></i>
                                            <div class="fw-bold">Card</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="payment-method rounded-4 border p-3 text-center shadow-sm" data-method="Mobile">
                                            <i class="fas fa-mobile-alt fa-2x mb-2 text-danger"></i>
                                            <div class="fw-bold">Mobile</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                
                        <!-- Cash Payment Details -->
                        <div class="card shadow-sm border-0 rounded-4 bg-light" id="cashPaymentDetails">
                            <div class="card-header bg-light py-3 rounded-top-4 border-0">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-calculator me-2 text-primary"></i>Cash Payment Details</h6>
                            </div>
                            <div class="card-body px-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="amountPaid" class="form-label">Amount Paid</label>
                                        <div class="input-group">
                                            <span class="input-group-text rounded-start-3 bg-white">Rs.</span>
                                            <input type="number" class="form-control rounded-end-3" id="amountPaid" min="0" step="0.01">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="changeDue" class="form-label">Change Due</label>
                                        <input type="text" class="form-control bg-white rounded-3" id="changeDue" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Order Summary -->
                    <div class="col-md-5">
                        <div class="card shadow border-0 rounded-4 h-100">
                            <div class="card-header bg-primary text-white py-3 rounded-top-4">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-shopping-basket me-2"></i>Order Summary</h6>
                            </div>
                            <div class="card-body p-4">
                                <!-- Summary Details -->
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Subtotal:</span>
                                    <span id="summary-subtotal" class="fw-bold">Rs.0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="text-muted">Tax (<span id="summary-tax-rate-display">15</span>%):</span>
                                    <span id="summary-tax" class="fw-bold">Rs.0.00</span>
                                </div>
                                
                                <!-- Discount Row -->
                                <div class="d-flex justify-content-between mb-3 discount-row">
                                    <span class="text-muted">Discount:</span>
                                    <div class="text-end">
                                        <span id="summary-discount" class="fw-bold">Rs.0.00</span>
                                        <div id="discount-details" class="small text-success mt-1 d-none">
                                            <span id="discount-type-display"></span>
                                            <button class="btn btn-sm text-danger p-0 remove-discount ms-2" title="Remove discount">
                                                <i class="fas fa-times-circle"></i> Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Total Line -->
                                <div class="d-flex justify-content-between py-3 my-3 border-top border-bottom total-line">
                                    <span class="fw-bold fs-5">Total:</span>
                                    <span id="summary-total" class="fw-bold fs-5 text-primary">Rs.0.00</span>
                                </div>
                                
                                <!-- Discount Code Section -->
                                <div class="discount-code-section mt-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-2 text-primary"></i>
                                        Apply Discount Code
                                    </label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control rounded-start-3" placeholder="Enter code" id="discount-code">
                                        <button class="btn btn-primary rounded-end-3" type="button" id="apply-discount-btn">Apply</button>
                                    </div>
                                    <div id="discount-message"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0 px-4 py-3 rounded-bottom-4">
                <button type="button" class="btn btn-lg btn-outline-secondary rounded-3 px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i> Cancel
                </button>
                <button type="button" class="btn btn-lg btn-success rounded-3 px-4" id="completePaymentBtn">
                    <i class="fas fa-check-circle me-2"></i> Process Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-4" id="successModalContent">
                <!-- Content will be dynamically inserted by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize cart and variables
        let cart = [];
        let subtotal = 0;
        let discountCode = '';
        let discount = 0;
        let discountType = 'fixed';
        let selectedPaymentMethod = 'Cash';
        
        // Tax rates from Django context
        const cardTaxRate = parseFloat('{{ card_tax_rate }}');
        const standardTaxRate = parseFloat('{{ standard_tax_rate }}');
        let currentTaxRate = standardTaxRate;  // Default tax rate
        
        // Helper function to show alerts
        function showAlert(message, type = 'info') {
            // Create toast notification
            const toast = `
                <div class="toast align-items-center text-white bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // Add toast to container
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Create toast container if it doesn't exist
                const container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
                container.innerHTML = toast;
            } else {
                toastContainer.innerHTML += toast;
            }
            
            // Initialize and show the toast
            const toastElement = document.querySelector('.toast:last-child');
            const bsToast = new bootstrap.Toast(toastElement, { delay: 3000 });
            bsToast.show();
        }
        
        // Initialize product cards - ensure out-of-stock items are properly disabled
        document.querySelectorAll('.product-card').forEach(productCard => {
            const isRunning = productCard.dataset.running === 'true';
            const stockElement = productCard.querySelector('.badge');
            
            if (!isRunning && stockElement) {
                const stockValue = parseInt(stockElement.textContent);
                if (stockValue <= 0) {
                    // Disable product card for zero stock non-running items
                    productCard.classList.add('disabled-product');
                    productCard.dataset.available = 'false';
                }
            }
        });
        
        function updateCartDisplay() {
            updateCart();
        }
        
        function updateCart() {
            const cartEl = $('#cart-items');
            if (cart.length === 0) {
                cartEl.html(`
                    <div class="empty-cart-message">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-3x mb-3 text-muted"></i>
                            <p class="text-muted">Your cart is empty</p>
                        </div>
                    </div>
                `);
                $('#btn-payment').prop('disabled', true);
            } else {
                let cartItems = '';
                cart.forEach((item, index) => {
                    cartItems += `
                        <div class="card mb-3 shadow-sm border-0 rounded-3">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <img src="${item.image || 'https://i.imgur.com/pTXpXpF.jpg'}" 
                                        class="rounded-3 me-3" alt="${item.name}" 
                                        style="width: 60px; height: 60px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 fw-bold text-truncate">${item.name}</h6>
                                        <span class="badge bg-light text-dark border">Rs.${item.price.toFixed(2)}</span>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger rounded-circle ms-2 btn-remove" data-index="${index}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        <button class="btn btn-outline-secondary rounded-start-2 btn-decrease" data-index="${index}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="text" class="form-control text-center border-secondary" value="${item.quantity}" readonly>
                                        <button class="btn btn-outline-secondary rounded-end-2 btn-increase" data-index="${index}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="fw-bold fs-5 text-primary">Rs.${(item.price * item.quantity).toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                cartEl.html(cartItems);
                $('#btn-payment').prop('disabled', false);
            }
            
            updateTotals();
        }
        
        function updateTotals() {
            const subtotal = calculateSubtotal();
            const tax = subtotal * (currentTaxRate / 100);
            
            // Calculate discount
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discount / 100);
            } else {
                discountAmount = discount;
            }
            
            const total = subtotal + tax - discountAmount;
            
            // Update tax rate display
            $('#tax-rate-display').text(currentTaxRate);
            $('#summary-tax-rate-display').text(currentTaxRate);
            
            $('#cart-subtotal').text('Rs.' + subtotal.toFixed(2));
            $('#cart-tax').text('Rs.' + tax.toFixed(2));
            $('#cart-discount').text('Rs.' + discountAmount.toFixed(2));
            $('#cart-total').text('Rs.' + total.toFixed(2));
            
            // Update payment modal
            $('#summary-subtotal').text('Rs.' + subtotal.toFixed(2));
            $('#summary-tax').text('Rs.' + tax.toFixed(2));
            $('#summary-discount').text('Rs.' + discountAmount.toFixed(2));
            $('#summary-total').text('Rs.' + total.toFixed(2));
            
            // Show/hide discount details based on whether a discount is applied
            if (discount > 0) {
                $('#discount-details').removeClass('d-none');
            } else {
                $('#discount-details').addClass('d-none');
            }
        }
        
        function calculateSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }
        
        // Add item to cart
        function addToCart(productId, name, price, image) {
            // Get the product element
            const productEl = document.querySelector(`.product-card[data-id="${productId}"]`);
            const isAvailable = productEl.dataset.available === 'true';
            const isRunning = productEl.dataset.running === 'true';
            
            // Check if product is available
            if (!isAvailable) {
                showAlert("This product is not available for ordering.", "danger");
                return;
            }
            
            // For non-running items, check current stock before proceeding
            if (!isRunning) {
                const currentStock = parseInt(productEl.querySelector('.badge').textContent);
                if (currentStock <= 0) {
                    showAlert("This product is out of stock.", "warning");
                    return;
                }
            }
            
            // Get the current item in cart if exists
            const existingItem = cart.find(item => item.id === productId);
            
            // If item exists, increment quantity, else add new item
            if (existingItem) {
                // For non-running items, check stock before adding
                if (!isRunning) {
                    const currentStock = parseInt(productEl.querySelector('.badge').textContent);
                    
                    // Check stock availability
                    if (currentStock <= 0) {
                        showAlert("Cannot add more. Stock limit reached.", "warning");
                        return;
                    }
                    
                    // Update the stock display in real-time
                    const newStockValue = currentStock - 1;
                    productEl.querySelector('.badge').textContent = newStockValue;
                    
                    // If stock reaches zero, disable the product card
                    if (newStockValue <= 0) {
                        productEl.classList.add('disabled-product');
                        productEl.dataset.available = 'false';
                    }
                }
                existingItem.quantity++;
                existingItem.total = existingItem.quantity * existingItem.price;
            } else {
                // For non-running items, update stock display immediately
                if (!isRunning) {
                    const currentStock = parseInt(productEl.querySelector('.badge').textContent);
                    const newStockValue = currentStock - 1;
                    
                    // Update the stock display
                    productEl.querySelector('.badge').textContent = newStockValue;
                    
                    // If stock reaches zero, disable the product card
                    if (newStockValue <= 0) {
                        productEl.classList.add('disabled-product');
                        productEl.dataset.available = 'false';
                    }
                }
                
                cart.push({
                    id: productId,
                    name: name,
                    price: parseFloat(price),
                    quantity: 1,
                    total: parseFloat(price),
                    image: image
                });
            }
            
            updateCartDisplay();
        }
        
        // Event Handlers
        // Add product to cart
        $(document).on('click', '.product-card', function() {
            const productId = $(this).data('id');
            const productName = $(this).data('name');
            const productPrice = parseFloat($(this).data('price'));
            const productImage = $(this).find('img').attr('src');
            
            addToCart(productId, productName, productPrice, productImage);
        });
        
        // Increase quantity
        $(document).on('click', '.btn-increase', function() {
            const index = $(this).data('index');
            const item = cart[index];
            
            // Get the product element to check stock
            const productEl = document.querySelector(`.product-card[data-id="${item.id}"]`);
            const isRunning = productEl.dataset.running === 'true';
            
            // For non-running items, check stock before adding more
            if (!isRunning) {
                const currentStock = parseInt(productEl.querySelector('.badge').textContent);
                if (currentStock <= 0) {
                    showAlert("Cannot add more. Stock limit reached.", "warning");
                    return;
                }
                
                // Update the stock display in real-time
                const newStockValue = currentStock - 1;
                productEl.querySelector('.badge').textContent = newStockValue;
                
                // If stock reaches zero, disable the product card
                if (newStockValue <= 0) {
                    productEl.classList.add('disabled-product');
                    productEl.dataset.available = 'false';
                }
            }
            
            // Increment quantity
            item.quantity += 1;
            updateCart();
        });
        
        // Function to restore stock when items are removed
        function restoreStock(productId, quantity) {
            // Only restore stock for non-running items
            const productEl = document.querySelector(`.product-card[data-id="${productId}"]`);
            if (productEl) {
                const isRunning = productEl.dataset.running === 'true';
                if (!isRunning) {
                    // Get current stock value
                    const currentStockElement = productEl.querySelector('.badge');
                    const currentStock = parseInt(currentStockElement.textContent);
                    
                    // Update stock display
                    const newStock = currentStock + quantity;
                    currentStockElement.textContent = newStock;
                    
                    // If product was disabled due to zero stock, re-enable it
                    if (currentStock <= 0 && newStock > 0) {
                        productEl.classList.remove('disabled-product');
                        productEl.dataset.available = 'true';
                    }
                }
            }
        }
        
        // Decrease quantity
        $(document).on('click', '.btn-decrease', function() {
            const index = $(this).data('index');
            const item = cart[index];
            
            if (item.quantity > 1) {
                // Decrease quantity by 1
                item.quantity -= 1;
                // Restore 1 stock
                restoreStock(item.id, 1);
            } else {
                // Restore all stock
                restoreStock(item.id, item.quantity);
                // Remove item from cart
                cart.splice(index, 1);
            }
            updateCart();
        });
        
        // Remove item
        $(document).on('click', '.btn-remove', function() {
            const index = $(this).data('index');
            const item = cart[index];
            
            // Restore all stock for this item
            restoreStock(item.id, item.quantity);
            
            // Remove from cart
            cart.splice(index, 1);
            updateCart();
        });
        
        // Clear cart
        $('#btn-clear').click(function() {
            if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
                // Restore stock for all items
                cart.forEach(item => {
                    restoreStock(item.id, item.quantity);
                });
                
                // Clear cart
                cart = [];
                updateCart();
            }
        });
        
        // Category filter
        $('.category-btn').click(function() {
            $('.category-btn').removeClass('active');
            $(this).addClass('active');
            
            const category = $(this).data('category');
            if (category === 'all') {
                $('.product-item').show();
            } else {
                $('.product-item').hide();
                $(`.product-item[data-category="${category}"]`).show();
            }
        });
        
        // Search products
        $('#product-search').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.product-item').each(function() {
                const productName = $(this).find('.card-title').text().toLowerCase();
                if (productName.includes(searchTerm)) {
                    $(this).show();
            } else {
                    $(this).hide();
                }
            });
        });
        
        // Payment Modal
        $('#btn-payment').click(function() {
            updateTotals();
            $('#paymentModal').modal('show');
            
            // Set default amount paid to total
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            $('#amountPaid').val(total.toFixed(2));
            calculateChange();
        });
        
        // Select payment method
        $(document).on('click', '.payment-method', function() {
            $('.payment-method').removeClass('selected');
            $(this).addClass('selected');
            
            selectedPaymentMethod = $(this).data('method');
            
            // Update tax rate based on payment method
            if (selectedPaymentMethod === 'Card') {
                currentTaxRate = cardTaxRate;
            } else {
                currentTaxRate = standardTaxRate;
            }
            
            // Update totals with new tax rate
            updateTotals();
            
            // Show cash details only for cash payments
            if (selectedPaymentMethod === 'Cash') {
                $('#cashPaymentDetails').show();
            } else {
                $('#cashPaymentDetails').hide();
            }
        });
        
        // Calculate change
        $('#amountPaid').on('input', function() {
            calculateChange();
        });
        
        function calculateChange() {
            const amountPaid = parseFloat($('#amountPaid').val() || 0);
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            const change = amountPaid - total;
            
            $('#changeDue').val(change >= 0 ? 'Rs.' + change.toFixed(2) : 'Rs.0.00');
        }
        
        // Complete payment
        $('#completePaymentBtn').click(function() {
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            const amountPaid = parseFloat($('#amountPaid').val() || 0);
            
            // Validate payment amount for cash
            if (selectedPaymentMethod === 'Cash' && amountPaid < total) {
                alert('Amount paid must be at least equal to the total amount');
                return;
            }
            
            // Get customer details
            const customerName = $('#customerName').val();
            const customerPhone = $('#customerPhone').val();
            const orderNotes = $('#orderNotes').val();
            
            // Create order data - ensure all numeric values are correctly formatted
            const subtotal = parseFloat($('#summary-subtotal').text().replace('Rs.', ''));
            const taxAmount = parseFloat($('#summary-tax').text().replace('Rs.', ''));
            const discountAmount = parseFloat($('#summary-discount').text().replace('Rs.', ''));
            
            const orderData = {
                customer_name: customerName,
                customer_phone: customerPhone,
                subtotal: subtotal.toFixed(2),
                tax_amount: taxAmount.toFixed(2),
                discount_amount: discountAmount.toFixed(2),
                total_amount: total.toFixed(2),
                payment_method: selectedPaymentMethod,
                payment_status: 'Pending',
                order_status: 'Pending',
                notes: orderNotes,
                discount_code: discountCode,
                // Add a flag to indicate that stock is already updated in UI
                stock_already_reduced: true,
                items: cart.map(item => ({
                    product_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price.toFixed(2),
                    total_price: (item.price * item.quantity).toFixed(2)
                }))
            };
            
            // Save order to server
            $.ajax({
                url: '/api/orders/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                dataType: 'json',
                success: function(response) {
                    console.log('Order saved:', response);
                    
                    // Close payment modal
                    $('#paymentModal').modal('hide');
                    
                    // Store order number for reference
                    const orderNumber = response.order_id;
                    
                    // Show success message with link to orders
                    $('#successModalContent').html(`
                        <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                        <h4>Processed Successfully!</h4>
                        <p>The order has been processed successfully.</p>
                        <p>Order #: <strong>${orderNumber}</strong></p>
                        <div class="mt-4">
                            <a href="/orders/" class="btn btn-primary">View in Orders</a>
                        </div>
                    `);
                    
                    $('#successModal').modal('show');
                    
                    // Clear cart
                    cart = [];
                    updateCart();
                },
                error: function(xhr, status, error) {
                    console.error('Error saving order:', error);
                    alert('There was an error processing the payment. Please try again.');
                }
            });
        });
        
        // Apply discount code
        $('#apply-discount-btn').click(function() {
            const code = $('#discount-code').val().trim();
            if (!code) {
                $('#discount-message').html('<div class="alert alert-warning">Please enter a discount code</div>');
                return;
            }
            
            // Clear previous messages
            $('#discount-message').empty();
            
            // Show loading message
            $('#discount-message').html('<div class="alert alert-info">Validating discount code...</div>');
            
            // Call API to validate discount code
            $.ajax({
                url: '/api/discounts/validate/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ code: code }),
                success: function(response) {
                    console.log("Discount API response:", response);
                    
                    if (response.valid) {
                        const discountData = response.discount;
                        discountCode = discountData.code;
                        discountType = discountData.type.toLowerCase();
                        discount = parseFloat(discountData.value);
                        
                        // Show success message
                        $('#discount-message').html(
                            `<div class="alert alert-success">
                                Discount "${discountData.name}" applied successfully!
                            </div>`
                        );
                        
                        // Show discount details
                        $('#discount-type-display').text(
                            discountType === 'percentage' ? 
                            `${discount}% off` : 
                            `Rs.${discount.toFixed(2)} off`
                        );
                        
                        // Clear the input field
                        $('#discount-code').val('');
                        
                        // Update totals
                        updateTotals();
                    } else {
                        // Show error message
                        $('#discount-message').html(`<div class="alert alert-danger">${response.message}</div>`);
                        
                        // Reset discount
                        resetDiscount();
                        updateTotals();
                    }
                },
                error: function(xhr) {
                    console.log("Discount API error:", xhr);
                    
                    let errorMsg = 'Error validating discount code';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    
                    // Show error message
                    $('#discount-message').html(`<div class="alert alert-danger">${errorMsg}</div>`);
                    
                    // Reset discount
                    resetDiscount();
                    updateTotals();
                }
            });
        });
        
        // Remove discount button click handler
        $(document).on('click', '.remove-discount', function() {
            // Reset discount values
            resetDiscount();
            
            // Show message
            $('#discount-message').html(
                `<div class="alert alert-info">
                    Discount has been removed successfully.
                </div>`
            );
            
            // Update totals to reflect removed discount
            updateTotals();
        });
        
        // Function to reset discount state
        function resetDiscount() {
            discountCode = '';
            discount = 0;
            discountType = 'fixed';
        }
        
        // Reset discount message when modal is opened
        $('#btn-payment').click(function() {
            $('#discount-message').empty();
            if (!discountCode) {
                $('#discount-code').val('');
            }
        });
        
        // Initialize cart
        updateCart();
    });
</script>
{% endblock %} 