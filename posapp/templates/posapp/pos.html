{% extends 'posapp/base.html' %}

{% block title %}POS System{% endblock %}

{% block extra_css %}
<style>
    .products-container {
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }
    .product-card {
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 8px;
        height: 100%;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .product-card .card-img-top {
        height: 120px;
        object-fit: cover;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .product-card .card-body {
        padding: 10px;
    }
    .product-card .card-title {
        font-size: 0.9rem;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .product-card .card-text {
        font-size: 1.1rem;
        font-weight: bold;
        color: #007bff;
    }
    .category-badge {
        cursor: pointer;
        transition: all 0.2s;
    }
    .category-badge.active {
        background-color: #007bff !important;
        color: white !important;
    }
    .category-badge:hover {
        transform: translateY(-2px);
    }
    .cart-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
    }
    .cart-items {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
    }
    .cart-summary {
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    .dark-mode .cart-summary {
        background-color: #343a40;
    }
    .empty-cart-message {
        display: flex;
        height: 100%;
        justify-content: center;
        align-items: center;
        color: #6c757d;
    }
    .cart-total {
        font-size: 1.2rem;
        font-weight: bold;
    }
    .quantity-control {
        display: flex;
        align-items: center;
    }
    .quantity-control button {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    .quantity-control input {
        width: 40px;
        text-align: center;
        margin: 0 5px;
    }
    .cart-actions {
        display: flex;
        gap: 10px;
    }
    .search-container {
        position: relative;
        margin-bottom: 15px;
    }
    .search-container .search-icon {
        position: absolute;
        left: 10px;
        top: 10px;
        color: #6c757d;
    }
    .search-container input {
        padding-left: 35px;
    }
    .payment-modal .payment-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    .payment-modal .payment-option {
        flex: 1;
        min-width: 100px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
    }
    .payment-modal .payment-option:hover {
        background-color: #f8f9fa;
    }
    .payment-modal .payment-option.selected {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    .dark-mode .payment-modal .payment-option:hover {
        background-color: #343a40;
    }
    .dark-mode .payment-modal .payment-option.selected {
        background-color: #0069d9;
    }
    /* Receipt styling */
    .receipt-preview {
        background: white;
        color: black;
        font-family: 'Courier New', monospace;
        padding: 10px;
        border: 1px solid #ddd;
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        font-size: 12px;
    }
    .receipt-header {
        text-align: center;
        margin-bottom: 10px;
    }
    .receipt-title {
        font-size: 14px;
        font-weight: bold;
        margin: 5px 0;
        text-align: center;
    }
    .receipt-subtitle {
        font-size: 12px;
        margin: 5px 0;
        text-align: center;
    }
    .receipt-info {
        margin-bottom: 10px;
        border-top: 1px dashed #000;
        border-bottom: 1px dashed #000;
        padding: 5px 0;
    }
    .receipt-items {
        width: 100%;
        border-collapse: collapse;
    }
    .receipt-items th, .receipt-items td {
        text-align: left;
        padding: 3px 0;
    }
    .receipt-items .right {
        text-align: right;
    }
    .receipt-total {
        margin-top: 10px;
        border-top: 1px dashed #000;
        padding-top: 5px;
    }
    .receipt-footer {
        margin-top: 10px;
        text-align: center;
        font-size: 11px;
    }
    .print-only {
        display: none;
    }
    @media print {
        body * {
            visibility: hidden;
        }
        .print-only, .print-only * {
            visibility: visible;
            display: block;
        }
        .print-only {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
    /* Payment method buttons */
    .payment-method {
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 10px;
    }
    .payment-method:hover {
        background-color: #f8f9fa;
    }
    .payment-method.selected {
        background-color: #007bff;
        color: white;
    }
    /* Dark mode styles for payment modal and success modal */
    .dark-mode .modal-content {
        background-color: #222;
        color: #f8f9fa;
    }
    .dark-mode .modal-header {
        border-bottom-color: #444;
    }
    .dark-mode .modal-footer {
        border-top-color: #444;
    }
    .dark-mode .payment-method {
        border-color: #444;
        color: #f8f9fa;
    }
    .dark-mode .payment-method:hover {
        background-color: #343a40;
    }
    .dark-mode .payment-method.selected {
        background-color: #007bff;
    }
    .dark-mode .form-control,
    .dark-mode .form-select {
        background-color: #333;
        border-color: #555;
        color: #f8f9fa;
    }
    .dark-mode .input-group-text,
    .dark-mode .btn-outline-secondary {
        background-color: #444;
        border-color: #555;
        color: #f8f9fa;
    }
    .dark-mode .card {
        background-color: #2a2a2a;
        border-color: #444;
    }
    .dark-mode .card-header {
        background-color: #333;
        border-bottom-color: #444;
    }
    
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-3">Point of Sale</h2>
    
    <div class="row">
        <!-- Products Section -->
        <div class="col-md-8">
            <!-- Categories -->
            <div class="mb-3 d-flex flex-wrap gap-2">
                <span class="badge bg-secondary py-2 px-3 category-badge active" data-category="all">All</span>
                {% for category in categories %}
                <span class="badge bg-secondary py-2 px-3 category-badge" data-category="{{ category.id }}">{{ category.name }}</span>
                {% endfor %}
            </div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="product-search" placeholder="Search products...">
            </div>
            
            <!-- Product Grid -->
            <div class="products-container">
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3" id="products-grid">
                    {% for product in products %}
                    <div class="col product-item" data-category="{{ product.category.id }}">
                        <div class="card product-card" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                            {% else %}
                            <img src="https://via.placeholder.com/150" class="card-img-top" alt="{{ product.name }}">
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">Rs.{{ product.price }}</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-4">
                        <p>No products available</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-md-4">
            <div class="cart-container">
                <div class="cart-items" id="cart-items">
                    <div class="empty-cart-message">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>Your cart is empty</p>
                        </div>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">Rs.0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (15%):</span>
                        <span id="cart-tax">Rs.0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Discount:</span>
                        <span id="cart-discount">Rs.0.00</span>
                    </div>
                    <div class="d-flex justify-content-between cart-total mb-3">
                        <span>Total:</span>
                        <span id="cart-total">Rs.0.00</span>
                    </div>
                    
                    <div class="cart-actions">
                        <button class="btn btn-secondary w-100" id="btn-discount">
                            <i class="fas fa-percent me-1"></i> Discount
                        </button>
                        <button class="btn btn-danger w-100" id="btn-clear">
                            <i class="fas fa-trash me-1"></i> Clear
                        </button>
                        <button class="btn btn-primary w-100" id="btn-payment" disabled>
                            <i class="fas fa-money-bill-wave me-1"></i> Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-7">
                <div class="mb-3">
                            <label for="customerName" class="form-label">Customer Name (Optional)</label>
                            <input type="text" class="form-control" id="customerName" placeholder="Enter customer name">
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Customer Phone (Optional)</label>
                            <input type="text" class="form-control" id="customerPhone" placeholder="Enter customer phone">
                </div>
                
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <div class="row">
                                <div class="col-6 col-md-4">
                                    <div class="payment-method selected" data-method="Cash">
                        <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                        <div>Cash</div>
                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="payment-method" data-method="Card">
                        <i class="fas fa-credit-card fa-2x mb-2"></i>
                        <div>Card</div>
                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="payment-method" data-method="Mobile Payment">
                        <i class="fas fa-mobile-alt fa-2x mb-2"></i>
                        <div>Mobile</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="cashPaymentDetails">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="amountPaid" class="form-label">Amount Paid</label>
                                    <input type="number" class="form-control" id="amountPaid" min="0" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label for="changeDue" class="form-label">Change Due</label>
                                    <input type="text" class="form-control" id="changeDue" readonly>
                                </div>
                    </div>
                </div>
                
                <div class="mb-3">
                            <label for="orderNotes" class="form-label">Order Notes (Optional)</label>
                            <textarea class="form-control" id="orderNotes" rows="2"></textarea>
                        </div>
                </div>
                
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Order Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="summary-subtotal">Rs.0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tax:</span>
                                    <span id="summary-tax">Rs.0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Discount:</span>
                                    <span id="summary-discount">Rs.0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2 fw-bold">
                                    <span>Total:</span>
                                    <span id="summary-total">Rs.0.00</span>
                </div>
                
                                <!-- Add discount code field -->
                                <div class="mt-3">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" placeholder="Discount Code" id="discount-code">
                                        <button class="btn btn-outline-secondary" type="button" id="apply-discount-btn">Apply</button>
                                    </div>
                                    <div id="discount-message"></div>
                </div>
                
                                <div class="mt-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="printReceipt" checked>
                                        <label class="form-check-label" for="printReceipt">
                                            Print receipt after payment
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="completePaymentBtn">
                    <i class="fas fa-check me-1"></i> Complete Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Template (hidden, used for printing) -->
<div id="receipt-template" class="print-only">
    <div class="receipt-preview">
        <div class="receipt-header">
            <div class="receipt-title">POS SYSTEM</div>
            <div class="receipt-subtitle">123 Main Street, City</div>
            <div class="receipt-subtitle">Phone: (123) 456-7890</div>
            </div>
        
        <div class="receipt-info">
            <div><strong>Receipt #:</strong> <span id="receipt-number"></span></div>
            <div><strong>Date:</strong> <span id="receipt-date"></span></div>
            <div><strong>Cashier:</strong> <span id="receipt-cashier"></span></div>
            <div id="receipt-customer-info"></div>
                </div>
                
        <table class="receipt-items">
            <thead>
                <tr>
                    <th style="width: 60%">Item</th>
                    <th class="right">Qty</th>
                    <th class="right">Price</th>
                </tr>
            </thead>
            <tbody id="receipt-items-body">
                <!-- Items will be inserted here -->
            </tbody>
        </table>
        
        <div class="receipt-total">
            <div class="d-flex justify-content-between">
                <span>Subtotal:</span>
                <span id="receipt-subtotal"></span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Tax:</span>
                <span id="receipt-tax"></span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Discount:</span>
                <span id="receipt-discount"></span>
            </div>
            <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span id="receipt-total"></span>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <span>Payment Method:</span>
                <span id="receipt-payment-method"></span>
            </div>
            <div class="d-flex justify-content-between" id="receipt-cash-details">
                <span>Amount Paid:</span>
                <span id="receipt-amount-paid"></span>
            </div>
            <div class="d-flex justify-content-between" id="receipt-change-details">
                <span>Change:</span>
                <span id="receipt-change"></span>
            </div>
                </div>
                
        <div class="receipt-footer">
            <p>Thank you for your purchase!</p>
            <p>Please visit us again</p>
                </div>
            </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4>Payment Successful!</h4>
                <p>The order has been completed successfully.</p>
                <div class="mt-4">
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="viewReceiptBtn">View Receipt</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Variables
        let cart = [];
        const taxRate = Number('{{ tax_rate|default:0 }}');
        let discount = 0;
        let discountType = 'fixed'; // 'fixed' or 'percentage'
        let discountCode = '';
        let selectedPaymentMethod = 'Cash';
        
        // Cart handling
        function updateCart() {
            const cartEl = $('#cart-items');
            if (cart.length === 0) {
                cartEl.html(`
                    <div class="empty-cart-message">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <p>Your cart is empty</p>
                        </div>
                    </div>
                `);
                $('#btn-payment').prop('disabled', true);
            } else {
                let cartItems = '';
                cart.forEach((item, index) => {
                    cartItems += `
                        <div class="card mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <img src="${item.image || 'https://via.placeholder.com/50'}" class="img-thumbnail me-2" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover;">
                                        <div>
                                            <h6 class="mb-0">${item.name}</h6>
                                            <small class="text-muted">Rs.${item.price.toFixed(2)} each</small>
                                        </div>
                                    </div>
                                    <div class="quantity-control">
                                        <button class="btn btn-sm btn-outline-secondary btn-decrease" data-index="${index}">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <input type="text" class="form-control form-control-sm" value="${item.quantity}" readonly>
                                        <button class="btn btn-sm btn-outline-secondary btn-increase" data-index="${index}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="font-weight-bold">Rs.${(item.price * item.quantity).toFixed(2)}</div>
                                    <button class="btn btn-sm btn-outline-danger btn-remove" data-index="${index}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                cartEl.html(cartItems);
                $('#btn-payment').prop('disabled', false);
            }
            
            updateTotals();
        }
        
        function updateTotals() {
            const subtotal = calculateSubtotal();
            const tax = subtotal * (taxRate / 100);
            
            // Calculate discount
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discount / 100);
                    } else {
                discountAmount = discount;
            }
            
            const total = subtotal + tax - discountAmount;
            
            $('#cart-subtotal').text('Rs.' + subtotal.toFixed(2));
            $('#cart-tax').text('Rs.' + tax.toFixed(2));
            $('#cart-discount').text('Rs.' + discountAmount.toFixed(2));
            $('#cart-total').text('Rs.' + total.toFixed(2));
            
            // Update payment modal
            $('#summary-subtotal').text('Rs.' + subtotal.toFixed(2));
            $('#summary-tax').text('Rs.' + tax.toFixed(2));
            $('#summary-discount').text('Rs.' + discountAmount.toFixed(2));
            $('#summary-total').text('Rs.' + total.toFixed(2));
        }
        
        function calculateSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }
        
        // Add item to cart
        function addToCart(product) {
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    image: product.image
                });
            }
            updateCart();
        }
        
        // Event Handlers
        // Add product to cart
        $(document).on('click', '.product-card', function() {
            const productId = $(this).data('id');
            const productName = $(this).data('name');
            const productPrice = parseFloat($(this).data('price'));
            const productImage = $(this).find('img').attr('src');
            
            addToCart({
                id: productId,
                name: productName,
                price: productPrice,
                image: productImage
            });
        });
        
        // Increase quantity
        $(document).on('click', '.btn-increase', function() {
            const index = $(this).data('index');
            cart[index].quantity += 1;
            updateCart();
        });
        
        // Decrease quantity
        $(document).on('click', '.btn-decrease', function() {
            const index = $(this).data('index');
            if (cart[index].quantity > 1) {
                cart[index].quantity -= 1;
            } else {
                cart.splice(index, 1);
            }
            updateCart();
        });
        
        // Remove item
        $(document).on('click', '.btn-remove', function() {
            const index = $(this).data('index');
            cart.splice(index, 1);
            updateCart();
        });
        
        // Clear cart
        $('#btn-clear').click(function() {
            if (cart.length > 0 && confirm('Are you sure you want to clear the cart?')) {
                cart = [];
                updateCart();
            }
        });
        
        // Category filter
        $('.category-badge').click(function() {
            $('.category-badge').removeClass('active');
            $(this).addClass('active');
            
            const category = $(this).data('category');
            if (category === 'all') {
                $('.product-item').show();
            } else {
                $('.product-item').hide();
                $(`.product-item[data-category="${category}"]`).show();
            }
        });
        
        // Search products
        $('#product-search').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.product-item').each(function() {
                const productName = $(this).find('.card-title').text().toLowerCase();
                if (productName.includes(searchTerm)) {
                    $(this).show();
            } else {
                    $(this).hide();
                }
            });
        });
        
        // Payment Modal
        $('#btn-payment').click(function() {
            updateTotals();
            $('#paymentModal').modal('show');
            
            // Set default amount paid to total
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            $('#amountPaid').val(total.toFixed(2));
            calculateChange();
        });
        
        // Select payment method
        $(document).on('click', '.payment-method', function() {
            $('.payment-method').removeClass('selected');
            $(this).addClass('selected');
            
            selectedPaymentMethod = $(this).data('method');
            
            // Show cash details only for cash payments
            if (selectedPaymentMethod === 'Cash') {
                $('#cashPaymentDetails').show();
            } else {
                $('#cashPaymentDetails').hide();
            }
        });
        
        // Calculate change
        $('#amountPaid').on('input', function() {
            calculateChange();
        });
        
        function calculateChange() {
            const amountPaid = parseFloat($('#amountPaid').val() || 0);
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            const change = amountPaid - total;
            
            $('#changeDue').val(change >= 0 ? 'Rs.' + change.toFixed(2) : 'Rs.0.00');
        }
        
        // Complete payment
        $('#completePaymentBtn').click(function() {
            const total = parseFloat($('#summary-total').text().replace('Rs.', ''));
            const amountPaid = parseFloat($('#amountPaid').val() || 0);
            
            // Validate payment amount for cash
            if (selectedPaymentMethod === 'Cash' && amountPaid < total) {
                alert('Amount paid must be at least equal to the total amount');
                return;
            }
            
            // Get customer details
            const customerName = $('#customerName').val();
            const customerPhone = $('#customerPhone').val();
            const orderNotes = $('#orderNotes').val();
            
            // Create order data
            const orderData = {
                customer_name: customerName,
                customer_phone: customerPhone,
                subtotal: parseFloat($('#summary-subtotal').text().replace('Rs.', '')),
                tax_amount: parseFloat($('#summary-tax').text().replace('Rs.', '')),
                discount_amount: parseFloat($('#summary-discount').text().replace('Rs.', '')),
                total_amount: total,
                payment_method: selectedPaymentMethod,
                payment_status: 'Paid',
                order_status: 'Completed',
                notes: orderNotes,
                items: cart.map(item => ({
                    product_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price,
                    total_price: item.price * item.quantity
                }))
            };
            
            // Save order to server
            $.ajax({
                url: '/api/orders/',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                dataType: 'json',
                success: function(response) {
                    console.log('Order saved:', response);
                    
                    // Close payment modal
                    $('#paymentModal').modal('hide');
                    
                    // Generate receipt if needed
                    if ($('#printReceipt').is(':checked')) {
                        generateReceipt(orderData, response.order_id);
                    }
                    
                    // Show success message
                    $('#successModal').modal('show');
                    
                    // Clear cart
                    cart = [];
            updateCart();
                },
                error: function(xhr, status, error) {
                    console.error('Error saving order:', error);
                    alert('There was an error processing the payment. Please try again.');
                }
            });
        });
        
        // Generate and print receipt
        function generateReceipt(orderData, orderId) {
            // Set receipt details
            $('#receipt-number').text(orderId);
            $('#receipt-date').text(new Date().toLocaleString());
            $('#receipt-cashier').text("{{ request.user.username }}");
            
            // Customer info if available
            let customerInfo = '';
            if (orderData.customer_name) {
                customerInfo += `<div><strong>Customer:</strong> ${orderData.customer_name}</div>`;
            }
            if (orderData.customer_phone) {
                customerInfo += `<div><strong>Phone:</strong> ${orderData.customer_phone}</div>`;
            }
            $('#receipt-customer-info').html(customerInfo);
            
            // Add items to receipt
            let itemsHtml = '';
            orderData.items.forEach(item => {
                const name = cart.find(i => i.id === item.product_id).name;
                itemsHtml += `
                    <tr>
                        <td>${name}</td>
                        <td class="right">${item.quantity}</td>
                        <td class="right">Rs.${(item.total_price).toFixed(2)}</td>
                    </tr>
                `;
            });
            $('#receipt-items-body').html(itemsHtml);
            
            // Set totals
            $('#receipt-subtotal').text('Rs.' + orderData.subtotal.toFixed(2));
            $('#receipt-tax').text('Rs.' + orderData.tax_amount.toFixed(2));
            $('#receipt-discount').text('Rs.' + orderData.discount_amount.toFixed(2));
            $('#receipt-total').text('Rs.' + orderData.total_amount.toFixed(2));
            
            // Payment details
            $('#receipt-payment-method').text(orderData.payment_method);
            
            // For cash payments, show amount paid and change
            if (orderData.payment_method === 'Cash') {
                const amountPaid = parseFloat($('#amountPaid').val());
                const change = amountPaid - orderData.total_amount;
                $('#receipt-amount-paid').text('Rs.' + amountPaid.toFixed(2));
                $('#receipt-change').text('Rs.' + change.toFixed(2));
                $('#receipt-cash-details, #receipt-change-details').show();
            } else {
                $('#receipt-cash-details, #receipt-change-details').hide();
            }
            
            // Print receipt
            window.print();
        }
        
        // View receipt button
        $('#viewReceiptBtn').click(function() {
            window.print();
        });
        
        // Apply discount code
        $('#apply-discount-btn').click(function() {
            const code = $('#discount-code').val().trim();
            if (!code) {
                $('#discount-message').html('<div class="alert alert-warning">Please enter a discount code</div>');
                return;
            }
            
            // Clear previous messages
            $('#discount-message').empty();
            
            // Show loading message
            $('#discount-message').html('<div class="alert alert-info">Validating discount code...</div>');
            
            // Call API to validate discount code
            $.ajax({
                url: '/api/discounts/validate/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ code: code }),
                success: function(response) {
                    console.log("Discount API response:", response);
                    
                    if (response.valid) {
                        const discountData = response.discount;
                        discountCode = discountData.code;
                        discountType = discountData.type.toLowerCase();
                        discount = parseFloat(discountData.value);
            
            // Show success message
                        $('#discount-message').html(
                            `<div class="alert alert-success">
                                Discount "${discountData.name}" applied: 
                                ${discountType === 'percentage' ? discount + '%' : 'Rs.' + discount.toFixed(2)} off
                            </div>`
                        );
                        
                        // Update totals
                        updateTotals();
                    } else {
                        // Show error message
                        $('#discount-message').html(`<div class="alert alert-danger">${response.message}</div>`);
                        
                        // Reset discount
                        discountCode = '';
                        discount = 0;
                        discountType = 'fixed';
                        updateTotals();
                    }
                },
                error: function(xhr) {
                    console.log("Discount API error:", xhr);
                    
                    let errorMsg = 'Error validating discount code';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    
                    // Show error message
                    $('#discount-message').html(`<div class="alert alert-danger">${errorMsg}</div>`);
                    
                    // Reset discount
                    discountCode = '';
                    discount = 0;
                    discountType = 'fixed';
                    updateTotals();
                }
            });
        });
        
        // Initialize cart
        updateCart();
    });
</script>
{% endblock %} 